blueprint:
  name: Timer-Based Lighting Automation (v2025.12.26.16.00)
  author: Dima Tokar
  source_url: https://github.com/dimatx/home-assistant/blob/main/blueprints/timer_driven_lighting_blueprint.yaml
  homeassistant:
    min_version: 2025.1.0
  description: >
    Logic: Restart the timer ONLY if the new duration would result in a 
    later expiration time than what is currently set.
  domain: automation
  input:
    configuration:
      name: Configuration
      icon: mdi:cogs
      input:
        timer_entity:
          name: Timer Entity
          selector:
            entity:
              domain: timer
        lights:
          name: Lights to Control
          selector:
            target:
              entity:
                domain: light
        trigger_entities:
          name: Trigger Entities
          selector:
            entity:
              multiple: true
        trigger_states:
          name: Trigger States
          default: "on"
          selector:
            text:
    condition_settings:
      name: Conditions
      icon: mdi:filter-variant
      input:
        global_conditions:
          name: Global Conditions
          default: []
          selector:
            condition:
        turn_on_conditions:
          name: Turn ON Conditions
          default: []
          selector:
            condition:
        turn_off_conditions:
          name: Turn OFF Conditions
          default: []
          selector:
            condition:
    other_settings:
      name: Other Settings
      icon: mdi:timer-cog
      collapsed: true
      input:
        timer_duration:
          name: Timer Duration (Optional)
          default: ""
          selector:
            duration:

mode: restart

variables:
  timer_entity_id: !input timer_entity
  trigger_states_input: !input trigger_states
  trigger_states_list: "{{ (trigger_states_input | string).split(',') | map('trim') | list }}"
  timer_duration_value: !input timer_duration

trigger:
  - platform: state
    entity_id: !input timer_entity
    from: idle
    to: active
    id: timer_active
  - platform: state
    entity_id: !input timer_entity
    to: idle
    id: timer_idle
  - platform: state
    entity_id: !input trigger_entities
    id: entity_triggered

condition:
  - condition: and
    conditions: !input global_conditions

action:
  - choose:
      # --- TRIGGER LOGIC ---
      - conditions:
          - condition: trigger
            id: entity_triggered
          - condition: template
            value_template: "{{ trigger.to_state.state in trigger_states_list }}"
          # Only restart if the timer is idle OR the new duration is longer than the remaining time
          - condition: template
            value_template: >
              {% set t = timer_entity_id %}
              {% if states(t) == 'idle' %}
                true
              {% else %}
                {% set desired = timer_duration_value if timer_duration_value else state_attr(t, 'duration') %}
                {% set remaining = state_attr(t, 'finishes_at') %}
                {{ as_timedelta(desired).total_seconds() > (as_timestamp(remaining) - as_timestamp(now())) if remaining else true }}
              {% endif %}
        sequence:
          - action: timer.start
            data:
              entity_id: !input timer_entity
              duration: "{{ timer_duration_value if timer_duration_value else skip }}"

      # --- LIGHTS ON ---
      - conditions:
          - condition: trigger
            id: timer_active
          - condition: and
            conditions: !input turn_on_conditions
        sequence:
          - action: light.turn_on
            target: !input lights

      # --- LIGHTS OFF ---
      - conditions:
          - condition: trigger
            id: timer_idle
          - condition: and
            conditions: !input turn_off_conditions
        sequence:
          - action: light.turn_off
            target: !input lights